%┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓%
%┃                                 MINTCODE                                   ┃%
%┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛%
% NOTE: This package requires the minted package.
% NOTE: This package uses `pygments` to highlight code.
% NOTE: If you use this package independently, you need to define the colors!

\ProvidesPackage{code}[2024/08/13 A minted based package for coding]

% Import required packages  
\RequirePackage{fontspec}
\RequirePackage{tcolorbox}
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{xpatch}
\tcbuselibrary{minted}
\tcbuselibrary{skins}

%┌────────────────────────────────────────────────────────────────────────────┐%
%│                            Common Settings																	│%
%└────────────────────────────────────────────────────────────────────────────┘%

% Set mono font for code
\setmonofont{JetBrainsMono}[
    Path=./fonts/static/,
    Scale=0.85,
    Extension=.ttf,
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    BoldItalicFont=*-BoldItalic
]

% Line Numbers style and color
\colorlet{numerscolor}{boxcolor!60!textcolor}
\renewcommand{\theFancyVerbLine}{\sffamily
\textcolor{numerscolor}{\arabic{FancyVerbLine}}}

% Patches for red boxes problem in minted
\makeatletter
\AtBeginEnvironment{minted}{\dontdofcolorbox}
\def\dontdofcolorbox{\renewcommand\fcolorbox[4][]{##4}}
\makeatother

\makeatletter
\AtBeginEnvironment{minted}{\dontdofcolorbox}
\def\dontdofcolorbox{\renewcommand\fcolorbox[4][]{##4}}
\xpatchcmd{\inputminted}{\minted@fvset}{\minted@fvset\dontdofcolorbox}{}{}
\xpatchcmd{\mintinline}{\minted@fvset}{\minted@fvset\dontdofcolorbox}{}{} % see https://tex.stackexchange.com/a/401250/
\makeatother

%┌────────────────────────────────────────────────────────────────────────────┐%
%│                              Languages Styles															│%
%└────────────────────────────────────────────────────────────────────────────┘%
% TODO: define the pseudocode style

% Inline Code ─────────────────────────────────────────────────────────────────
\NewDocumentCommand{\cc}{ O{bash} m }{\mintinline{#1}{#2}}

% Python ──────────────────────────────────────────────────────────────────────
\newtcblisting{python}{
	% Minted Settings -----------------------------------------------------------
	listing engine				= minted,							% use minted engine
	minted style					=	default,						% pygments styles		
	minted language				=	python,							% NOTE: Python
  enhanced,                                   % enhanced mode
  listing only,                               % only listing
	% Minted Options ------------------------------------------------------------
	minted options = {
		breaklines,																% break long lines
		autogobble,																% remove leading spaces
		linenos,																	% enable line numbers
		fontsize						= \small,							% font size
		numbersep						= 4mm,								% line number separation
		obeytabs						= true,								% obey tabs in code
		tabsize							= 4,									% tab size
		python3							= true,								% enable python3 syntax
		mathescape					= true,								% enable math mode inside '$'
    escapeinside        = {§}{§},							% normal text inside '§' 
	},
	% Box Settings --------------------------------------------------------------
	colback								=	boxcolor,						% background color
	colframe							=	boxcolor,						% frame color
  boxrule               = 0pt,								% frame thickness
  arc                   = 2mm,								% corner radius
	left									=	7mm,								% left margin
	top										=	1mm,								% top margin
	bottom								=	1mm,								% bottom margin
	% Numbers Overlay Box -------------------------------------------------------
	overlay = {
		\begin{tcbclipinterior}\fill[boxcolor!90!textcolor]
			(frame.south west) rectangle ([xshift=5mm]frame.north west);
		\end{tcbclipinterior}
	}
}

% C ───────────────────────────────────────────────────────────────────────────
\newtcblisting{C}{
	% Minted Settings -----------------------------------------------------------
	listing engine				= minted,							% use minted engine
	minted style					=	default,						% pygments styles		
	minted language				=	c,									% NOTE: C
	enhanced,                                   % enhanced mode
	listing only,                               % only listing
	% Minted Options ------------------------------------------------------------
	minted options = {
		breaklines,																% break long lines
		autogobble,																% remove leading spaces
		linenos,																	% enable line numbers
		fontsize						= \small,							% font size
		numbersep						= 4mm,								% line number separation
		obeytabs						= true,								% obey tabs in code
		tabsize							= 4,									% tab size
		mathescape					= true,								% enable math mode inside '$'
		escapeinside        = {§}{§},							% normal text inside '§' 
	},
	% Box Settings --------------------------------------------------------------
	colback								=	boxcolor,						% background color
	colframe							=	boxcolor,						% frame color
	boxrule               = 0pt,								% frame thickness
	arc                   = 2mm,								% corner radius
	left									=	7mm,								% left margin
	top										=	1mm,								% top margin
	bottom								=	1mm,								% bottom margin
	% Numbers Overlay Box -------------------------------------------------------
	overlay = {
		\begin{tcbclipinterior}\fill[boxcolor!90!textcolor]
			(frame.south west) rectangle ([xshift=5mm]frame.north west);
		\end{tcbclipinterior}
	}
}

% C++ ─────────────────────────────────────────────────────────────────────────
\newtcblisting{cpp}{
	% Minted Settings -----------------------------------------------------------
	listing engine				= minted,							% use minted engine
	minted style					=	default,						% pygments styles		
	minted language				=	cpp,								% NOTE: C++
	enhanced,                                   % enhanced mode
	listing only,                               % only listing
	% Minted Options ------------------------------------------------------------
	minted options = {
		breaklines,																% break long lines
		autogobble,																% remove leading spaces
		linenos,																	% enable line numbers
		fontsize						= \small,							% font size
		numbersep						= 4mm,								% line number separation
		obeytabs						= true,								% obey tabs in code
		tabsize							= 4,									% tab size
		mathescape					= true,								% enable math mode inside '$'
		escapeinside        = {§}{§},							% normal text inside '§' 
	},
	% Box Settings --------------------------------------------------------------
	colback								=	boxcolor,						% background color
	colframe							=	boxcolor,						% frame color
	boxrule               = 0pt,								% frame thickness
	arc                   = 2mm,								% corner radius
	left									=	7mm,								% left margin
	top										=	1mm,								% top margin
	bottom								=	1mm,								% bottom margin
	% Numbers Overlay Box -------------------------------------------------------
	overlay = {
		\begin{tcbclipinterior}\fill[boxcolor!90!textcolor]
			(frame.south west) rectangle ([xshift=5mm]frame.north west);
		\end{tcbclipinterior}
	}
}

% Bash ────────────────────────────────────────────────────────────────────────
\newtcblisting{bash}{
	% Minted Settings -----------------------------------------------------------
	listing engine				= minted,							% use minted engine
	minted style					=	default,						% pygments styles		
	minted language				=	bash,								% NOTE: Bash
	enhanced,                                   % enhanced mode
	listing only,                               % only listing
	% Minted Options ------------------------------------------------------------
	minted options = {
		breaklines,																% break long lines
		autogobble,																% remove leading spaces
		linenos,																	% enable line numbers
		fontsize						= \small,							% font size
		numbersep						= 4mm,								% line number separation
		obeytabs						= true,								% obey tabs in code
		tabsize							= 4,									% tab size
		mathescape					= true,								% enable math mode inside '$'
		escapeinside        = {§}{§},							% normal text inside '§' 
	},
	% Box Settings --------------------------------------------------------------
	colback								=	boxcolor,						% background color
	colframe							=	boxcolor,						% frame color
	boxrule               = 0pt,								% frame thickness
	arc                   = 2mm,								% corner radius
	left									=	7mm,								% left margin
	top										=	1mm,								% top margin
	bottom								=	1mm,								% bottom margin
	% Numbers Overlay Box -------------------------------------------------------
	overlay = {
		\begin{tcbclipinterior}\fill[boxcolor!90!textcolor]
			(frame.south west) rectangle ([xshift=5mm]frame.north west);
		\end{tcbclipinterior}
	}
}

% YAML ────────────────────────────────────────────────────────────────────────
\newtcblisting{yaml}{
	% Minted Settings -----------------------------------------------------------
	listing engine				= minted,							% use minted engine
	minted style					=	default,						% pygments styles		
	minted language				=	yaml,								% NOTE: YAML
	enhanced,                                   % enhanced mode
	listing only,                               % only listing
	% Minted Options ------------------------------------------------------------
	minted options = {
		breaklines,																% break long lines
		autogobble,																% remove leading spaces
		% linenos,																	% enable line numbers
		fontsize						= \fontsize{6}{11}\selectfont\linespread{0.6},
		% numbersep						= 2.5mm,								% line number separation
		obeytabs						= true,								% obey tabs in code
		tabsize							= 2,									% tab size
		mathescape					= true,								% enable math mode inside '$'
		escapeinside        = {§}{§},							% normal text inside '§' 
	},
	% Box Settings --------------------------------------------------------------
	colback								=	boxcolor,						% background color
	colframe							=	boxcolor,						% frame color
	boxrule               = 0pt,								% frame thickness
	arc                   = 2mm,								% corner radius
	left									=	1mm,								% left margin
	top										=	1mm,								% top margin
	bottom								=	1mm,								% bottom margin
	% Numbers Overlay Box -------------------------------------------------------
	% overlay = {
	% 	\begin{tcbclipinterior}\fill[boxcolor!90!textcolor]
	% 		(frame.south west) rectangle ([xshift=5mm]frame.north west);
	% 	\end{tcbclipinterior}
	% }
}
